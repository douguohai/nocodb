variables:
  RemoteUrlB: swr.cn-east-3.myhuaweicloud.com/ssstianmin
  WebURL_Dev: https://xtm.sss-xtm.com:7443/dev/sphjcriusadmin/web/
  WebURL_Alpha: https://xtm.sss-xtm.com:7443/alpha/sphjcriusadmin/web/
  DingToken: 1e336794c4b90331ba4999dc6188fd4820808952d046cd6657f7797ecca54107
  ProjectName: 远程视频会见-管理端
stages: # List of stages for jobs, and their order of execution
  - deploy-dev
  - deploy-alpha

deploy-dev: # This job runs in the build stage, which runs first.
  stage: deploy-dev
  tags:
    - shared
  variables:
    BaseImage: sphjcriusadmin
    RemoteUrl: 192.168.10.239:8888/charles0320
    AppRunEnv: dev
    NameSpace: dev
  only:
    - master
  before_script: [ ]
  script:
    - echo "try to build image and deploy ${AppRunEnv} start "
    - TIMESTAMP=$(date +%Y-%m-%d-%H%M%S) # 使用date命令将时间戳转换为Unix时间戳
    - RemoteImageName="${RemoteUrl}/${BaseImage}:${AppRunEnv}-${TIMESTAMP}"
    - echo "Compiling the code...${TIMESTAMP} ${AppRunEnv} ${REMOTE_TAG}"
    - nvm use 18 && npm install && npm run build:dev
    - docker build  -t "${RemoteImageName}" .
    - docker push "${RemoteImageName}"
    - docker rmi "${RemoteImageName}"
    - echo "Compile complete. Successfully build and push image ${RemoteImageName}"
    - echo "try to build image and deploy ${APP_RUN_ENV} end"
    - echo "kubectl set NameSpace ${NameSpace}  deployment/${BaseImage} image ${RemoteImageName}"
    - kubectl set image deployment/${BaseImage} ${BaseImage}=${RemoteImageName} -n ${NameSpace}
    - echo "kubectl set successfully"
    - noticejob deploy -e ${AppRunEnv} -v ${TIMESTAMP} -n ${BaseImage} -t ${DingToken} -u ${WebURL_Dev}
    - echo "通知发送成功"


deploy-alpha: # This job runs in the build stage, which runs first.
  stage: deploy-alpha
  tags:
    - shared
  variables:
    BaseImage: sphjcriusadmin
    RemoteUrl: 192.168.10.239:8888/charles0320
    AppRunEnv: alpha
    NameSpace: alpha
  only:
    - alpha
  before_script: [ ]
  script:
    - echo "try to build image and deploy ${AppRunEnv} start "
    - TIMESTAMP=$(date +%Y-%m-%d-%H%M%S) # 使用date命令将时间戳转换为Unix时间戳
    - RemoteImageName="${RemoteUrl}/${BaseImage}:${AppRunEnv}-${TIMESTAMP}"
    - echo "Compiling the code...${TIMESTAMP} ${AppRunEnv} ${REMOTE_TAG}"
    - nvm use 18 && npm install && npm run build:alpha
    - docker build  -t "${RemoteImageName}" .
    - docker push "${RemoteImageName}"
    - docker rmi "${RemoteImageName}"
    - echo "Compile complete. Successfully build and push image ${RemoteImageName}"
    - echo "try to build image and deploy ${APP_RUN_ENV} end"
    - echo "kubectl set NameSpace ${NameSpace}  deployment/${BaseImage} image ${RemoteImageName}"
    - kubectl set image deployment/${BaseImage} ${BaseImage}=${RemoteImageName} -n ${NameSpace}
    - echo "kubectl set successfully"
    - noticejob deploy -e ${AppRunEnv} -v ${TIMESTAMP} -n ${BaseImage} -t ${DingToken} -u ${WebURL_Dev}
    - echo "通知发送成功"
